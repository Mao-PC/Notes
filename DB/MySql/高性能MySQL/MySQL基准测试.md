[TOC]

# MySQL 基准测试

## 基准测试的策略

两种主要策略:

-   针对整个系统的整体测试, 集成式(full-stack)基准测试
-   单独测试 MySQL, 单组件(single-component)基准测试

测试整个系统, 包括 web 服务器 应用代码, 网络和数据库, 因为用户更关心整体性能, MySQL 也不总是应用瓶颈, 只有针对应用做整体测试才能发现各部分直接的缓存带来的影响. 更能揭示应用真实的表现

### 测试指标

-   吞吐量

    是在单位时间内的事务处理数. 常用的有每秒事务数(TPS), 每分钟事务数(TPM)

-   响应时间或者延迟

    最大的响应时间通常意义不大, 因为测试时间越长, 有可能响应时间也越长. 通常使用百分比响应时间(percentile response time), 如, 95%的响应是 5ms, 那么 95%的任务都可以在 5ms 内完成

-   并发性

    web 服务器的并发性应该是**在任意时间有多少同时发生的并发请求**

    并发性**不是**多少用户在同一实际流量一个 web 站点, 同时打开成败上千个 MySQL 数据库连接, 但是可能只有少数连接在执行查询

    并发性基准测试需要关注的是正在工作中的并发操作, 或者是同时工作中国 的线程数或者连接数. 当并发性增加时, 需要测试吞吐量是否下降, 响应时间是否变长, 如果这样, 应用可能无法处理峰值压力

-   可扩展性

    在业务压力可能发生变化的情况下,测试可扩展性就非常必要了. 具体将会在 [可扩展的 MySQL](可扩展的MySQL.md) 中讲述

## 测试基准方法

一些常见的错误会导致结果不准确或者无用:

-   使用的真实数据的子集而不是全集
-   使用错误的数据分布
-   使用不真实的分布参数, 例如假定所有的用户个人信息都会被平均的读取
-   在多用户场景中, 只做单用户模拟
-   在但服务器上厕所分布式应用
-   与真是用户行为不匹配. 例如真实的用户在请求到一个页面后悔阅读一段时间而不是不停顿的一个接一个的点击链接
-   反复测试同一个查询, 这可能会导致会将所有的结果缓存.
-   没有坚持错误, 一个很慢的 SQL 突然执行快了, 有可能是因为 SQL 发生率错误导致的
-   忽略了系统预热的过程
-   使用默认的服务器配置 在 [服务器性能剖析](服务器性能剖析.md) 会详细讨论中
-   测试时间太短

### 设计和规划基准测试

基准测试:

1. 获取生产数据集快照, 改快照很容易还原, 以便后续的测试
2. 针对数据运行查询.

    可以进行初步单元测试, 并多次运行. 但是更好是选择一个代表性的时间段, 比如高峰期的一个小时, 或者一整天, 记录整个生产系统的所有查询. 如果时间段比较小那么可以选择多个时间段, 这样有助于覆盖整个系统的活动状态, 例如每周报表的查询或者非峰值时间的运行的批处理作业

### 基准测试应该运行多长时间

应该运行**足够长的时间**. 有时候无法确认测试需要运行多长时间才足够, 可以让测试一直运行, 持续观察直到确认系统已经稳定运行, 然后在稳定状态下进行测试

### 获取系统性能和状态

在测试时需要尽可能多的手机被测试系统的信息. 如 CPU 使用率, 磁盘 IO, 网络流量统计, show global status 计数器等. 即时有些结果不是目前需要的, 多余一些数据总比缺乏重要数据要好很多

### 获得基准测试结果

在获取结果前需要确认:

-   是否选择了正确的基准测试
-   是否为问题收集了相关数据
-   是否采用了错误的测试标准

接着要确认结果是否可重复, 每次重新测试之前要确保系统的状态是一致的, 要利用快照还原数据, 要注意很多因素, 包括外部的压力, 性能分析和监控系统, 详细的日志记录, 周期性作业以及一些其他因素, 都会影响到测试结果. 一个典型的阿尼, 就是测试过程中突然执行 cron 定时作业启动或者正处于一个巡查读取周期

在每次测试中, 修改的参数应该尽量少, 如果一次性修改多个参数很可能会丢失一些信息

最后, 如果测试中出现异常结果, 不用轻易当做坏数据点儿丢弃, 应该认真研究并找到产生这种结果的原因

### 运行基准测试并分析结果

基准测试通常昔阳运行多次, 如果结果变化很大, 可以再多运行几次或者运行更长的时间

获取到结果后, 还需要进行结果分析, 也就是把数组变成知识

### 绘图的重要性

通过图形可以立刻发现一些问题, 而这些问题在原始数据中却很难注意到

如, MySQL 正在遭受 "疯狂刷新" 的问题, 在属性落后于检查点是会阻塞所有活动, 从而导致吞吐量下降, 95%的响应时间和平均响应时间指标都无法发现这个问题, 但是图像会显示出这个周期性问题. 折线图像上会明显的看到周期性的下降

## 基准测试工具

> 集成测试工具

-   ab, Apache HTTP 服务器测试工具, 只能对单个 URL 进行压测
-   http_load: 和 ab 类似, 但是比 ab 灵活
-   JMeter: 可以灵活的模拟真实用户访问, 还有绘图窗口, 比较推荐

> 单组件测试工具

-   mysqlslap

    可以模拟服务器负载并输出计时信息. 可以指定 SQL 语音没有 SQL 语句会自动生成查询 schema 的 SELECT 语句

-   MySQL Benchmark Suite(sql-bench)

    MySQL 发行包提供了自己的基准测试组件. 是单线程的主要用于测试服务器执行查询的速度, 包含了大量的预定义测试, 容易使用, 可以很轻松的比较不同存储引擎的性能测试. 也可以用于比两个服务器的总体性能

    缺点是单用户模式, 测试的数据集很小且用户无法使用指定数据, 同一个测试多次运行的结果可能会相差很大

-   Super Smack

    用于 MySQL 和 postgreSQL 的基准测试工具, 可以提供压力测试和负载生产, 是一个负载且强大的工具, 可以模拟多用户访问

-   Database Test Suite

    开源软件开发实验室设计的, 一款类似某些工业标准的测试工具集

-   Percona's TPCC-MySQL Tool

    这本书作者开发的, 专用于 MySQL 测试

-   sysbench

    多线程压测工具, 可以根据影响数据库服务器性能的各种因素来评估系统的性能, 非常灵活是一种全能测试工具, 支持 MySQL, 操作系统和硬件测试

## 测试案例 (略)
