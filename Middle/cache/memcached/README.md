[TOC]

# Memcached

## Memcached 入门

文档地址: https://github.com/memcached/memcached/wiki

Memcached 是一个缓存系统, 通过减轻数据库负载加速动态 web 应用

-   本质就是一个内存 K-V 缓存
-   协议简单, 是基于文本行的协议
-   不支持数据库持久化, 服务器关闭之后数据全部丢失
-   简洁而强大, 上手容易
-   没有安全机制

**Memcached 的设计理念**:

-   简单的 K-V 存储, 服务器不关心数据时什么, 只管存储数据
-   服务端功能简单, 很多逻辑需要客户端实现.
    -   服务端专注如何存储, 合适清除和重用内存
    -   客户端专注如何选择读取和写入服务器, 以及无法联系到服务器时的操作
-   Memcached 实例之间没有通信机制
-   每个命令的复杂度为 O(1). 慢速机上查询应该在 1ms 以下, 高端服务器可达每秒数百万
-   缓存自动清除机制
-   缓存失效机制

具体搭建过程请参考: [memcached 单机到集群完整搭建过程](https://github.com/Mao-PC/Notes/blob/master/Middle/cache/memcached/memcached%E5%8D%95%E6%9C%BA%E5%88%B0%E9%9B%86%E7%BE%A4%E5%AE%8C%E6%95%B4%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B.md.pdf)

**常用命令**

![常用命令](res/常用命令.png)

这里推荐使用客户端: Java 客户端 (xmemcached)

**Memcached 性能**

Memcached 性能的关键是硬件, 内部实现是 hash 表, 读写操作都是 O(1), 硬件好, 几百万 QPS 都是没问题的

**最大连接数限制**: 内部基于事件机制 (类似 Java 的 NIO), 只要内存, 操作系统参数进行调整, 轻松几十万

**集群数量限制**: 理论是没有限制的但是节点越多客户端建立的连接就会越多. 如果存储的数据很多, 优先考虑增加内存, 成本太高的情况下再增加节点

Memcached 没有分布式功能, 所以不论是集群还是主从备份, 都需要第三方产品支持

**Memcached 对服务器硬件要求**

-   CPU 要求: CPU 占用率低, 默认为 4 个工作线程
-   内存要求: 对内存要求高, 建议 Memcached 独占服务器而不是混用, 建议每个 Memcached 实例的内存大小都是一致的, 如果不一致则需要权重调整
-   网络要求: 根据传输内容来定, 网络越大越好, 通常 10M 就够用了, 建议: 项目在 Memcached 传输的内容尽可能小

**Memcached 应用场景**

1. 数据查询缓存
2. 计数器场景: 通过 incr/decr 命令实现评论数量, 点击数量统计
3. 乐观锁实现: 计划任务多实例部署, 通过 cas 实现不重复执行
4. 防止重复处理: cas 命令

## Memcached 内存管理
