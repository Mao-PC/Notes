[toc]

# 搜索引擎核心思想



## 搜索引擎



### 为什么需要搜索引擎



一般我们使用数据库 (MySQL, Oracle 等), 如果使用数据库来存储新闻一般都需要如下字段

| id       | bigint       |
| -------- | ------------ |
| 标题     | varchar(100) |
| 内容     | med iumtext  |
| 所属类型 | bigint       |
| 作者     | varchar(100) |
| 发表时间 | datetime     |

如何在数据库做如下查询

- 按类别查询 

  ```sql
  select * from 新闻表 where 类别 in ( ... )
  ```

- 按时间查询

  ```sql
  select * from 新闻表 where 时间 between xxx and xxx
  ```

- 查询标题 "xxxx"

  ```sql
  select * from 新闻表 where 标题 = 'xxx'
  ```

- 查询与 "xxx" 有关的新闻

  ```sql
  select * from 新闻表 where 标题 like '%xxx%' or 内容 like '%xxx%'
  ```



单数据量变大后如何优化?

>  建索引, 分库分表



创建索引对于 `查询与 "xxx" 有关的新闻` 有效果么?

> 索引就是对列值创建排序存储, 数据结构 = {列值, 行地址}. 在有序数据列表中就可以利用二分查找快速找到要查找的行的地址, 再根据地址直接取行数据
>
> 对表中的类型, 时间创建索引, 可以按照一定的规律进行排序, 对应文本列只能使用字符集编码进行排序
>
> 所以对标题创建索引后并不能对 **'%xxx%'** 进行有效优化



 综上, **数据库适合结构化数据的进去查询, 而不适合办结构化, 非结构化数据的模糊查询及灵活搜索**

- 结构化数据：用表、字段表示的数据
- 半结构化数据：XML HTML
- 非结构化数据：文本、文档、图片、音频、视频等



### 反向索引



1. 搜索引擎是如何能够快速执行 `查询与 "xxx" 有关的新闻` 的?

   **问题**：比如我们在查询“苍老师”时，想要得到标题或者内容中包含“苍老师”的新闻列表，我们如何快速查询呢？
   **解答**：我们需要一个索引，这个索引能够根据关键字查找出对应的文章ID。结构类似如下

   ![](https://img-blog.csdnimg.cn/20190604191104690.png)

   这就是**反向索引**，这也是搜索引擎的核心思想. 英文 **Inverted index**, 也叫倒排索引

   

   正向索引是 `id => 词条` ,  反向索引 `词条 => id`

   <img src="https://pic1.zhimg.com/80/v2-bd52c3f43418c77122179121aafee944_720w.jpg" style="zoom:67%;" />
2. **合并另个索引可以吗？怎么合并？**

<img src="https://www.pianshen.com/images/643/d5cfedacfc2833f24ac6060feda41923.png" style="zoom:67%;" />

3. **反向索引的记录数会不会很大？**

<img src="https://www.pianshen.com/images/646/97aaee7151576e1491f7306694bf439e.png" style="zoom:67%;" />



4. **如何建立这样一个索引**

<img src="https://www.pianshen.com/images/662/75f92efb1ccc49fd9d79326efeca053e.png" style="zoom:67%;" />



5. **如果要开发一个中文分词器，你觉得该怎么实现对一句话进行分词？**

<img src="https://www.pianshen.com/images/338/55bfc9fc6d8355c8a22fe393de1cfc22.png" style="zoom:67%;" />

6. **java开源中文分词器有哪些？**

<img src="https://www.pianshen.com/images/384/3c3928da52b3f8c7db9e422a6f53ec10.png" style="zoom:67%;" />

7. **分词器在分词时能不能统计出词的出现次数、位置？有什么作用？**

<img src="https://www.pianshen.com/images/84/582aefcfa7727633956b364af88c4df4.png" style="zoom:67%;" />

8. **你、我、他、的、地、了、标点符号……这些需要为其创建索引吗？**

   这种词一般称为停用词，不会被索引

9. **当出现了新词了，该怎么办？**

   分词器要有添加扩充词典功能



综上, 搜索引擎快速执行 `查询与 "xxx" 有关的新闻` 就需要**对数据进行分层, 建立反向索引**



### 如何使用反向索引进行搜索



<img src="https://www.pianshen.com/images/610/a3bb93126246085f6762c91e3413d8d2.png" style="zoom:80%;" />

1. 合并后列表该如何排序？
   我们希望最相关的排在最前面

2. 相关性如何度量？
   人可以通过读内容判定相关性，机器不懂人话。
   得建立一套能评估相关性的模型

3. 如何根据次数建立一个相关性评估模型？

   - 统计出现的次数, 根据次数从高到低排

   - 加入权重

     如: 标题权重 10, 内容权重 1, 计算权重得分



### 其他



- 数据更新时，索引是不是必须得更新？好更新吗？

  在存储新的文章时

  - 有新的文章被存储时, 需要对文章进行分词
  - 如果词典中有分词后的词条, 就在该词条后保存文章的 id
  - 如果分词不存在, 就在词典中添加新词, 在该词条后保存文章的 id

  在删除文章时

  - 找到对应分词后删除文章的 id

  修改文章

  - 将文章删除 --> 新增

- 反向索引是存储在内存中，还是磁盘中合适？反向索引会有多大？

  - 数据量小, 放到内存中, 但是需要考虑持久化问题已经宕机的数据丢失
  - 数据量大, 放到磁盘中, 但是读写效率不高

- 搜索引擎需要支持精确搜索吗？需要支持像数据库一样的多条件 AND OR 组合搜索吗

  必须支持



## Lucene



最受欢迎的java开源全文搜索引擎开发工具包。提供了完整的查询引擎和索引引擎，部分文本分词引擎。Lucene 的目的是为软件开发人员提
供一个简单易用的工具包，以方便在目标系统中实现全文检索功能，或者是以此为基础建立起完整的全文检索引擎。

是Apache的子项目，网址：http://lucene.apache.org/



Lucene在ES中的应用

ES将index的数据分为多份，每份叫一个shard，为了提高数据可用性，每个shard都会有冗余副本，每个副本实际上是一个Lucene index实例.

![](https://www.pianshen.com/images/927/a40bb4cc21976edc982ce5835942a12f.png)

**shard**

一个index可能存储大量的数据，以至于一台机器存放不下，即使能承载，由单台机器查询全量数据，也相当耗时。为了解决这个问题，ES将index中数据分为多份，每份叫一个shard。

**replica**

replica即为shard的备份，每个shard可以有多个replica，其中一个位
primary shard，剩余的为replica shard。Replica除可以起到容错的作用外，还可以提高查询并发度。