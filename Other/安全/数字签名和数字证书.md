[toc]

# 数字签名和数字证书



## 对称加密



采用单钥密码系统的加密方法，同一个密钥可以同时用作信息的加密和解密，这种加密方法称为对称加密，也称为单密钥加密。

在对称加密算法中常用的算法有：DES、3DES、TDEA、Blowfish、RC2、RC4、RC5、IDEA、SKIPJACK等。

需要对加密和解密使用相同密钥的加密算法。由于其**速度快**，`对称性加密通常在消息发送方需要加密大量数据时使用`。对称性加密也称为**密钥加密**。

所谓对称，就是采用这种加密方法的双方使用方式用同样的密钥进行加密和解密。密钥是控制加密及解密过程的指令。算法是一组规则，规定如何进行加密和解密。

因此加密的安全性不仅取决于加密算法本身，密钥管理的安全性更是重要。`因为加密和解密都使用同一个密钥，如何把密钥安全地传递到解密者手上就成了必须要解决的问题。`

如果所有客户端都共享同一个密匙, 那么这个密钥就像万能钥匙一样, 可以凭借一个密匙破解所有人的密文. 如果每个客户端与服务端单独维护一个秘密, 那么服务端需要管理的秘钥将是成千上万, 这会给服务端带来噩梦



## 非对称加密



对称加密算法在加密和解密时使用的是同一个秘钥；而非对称加密算法需要两个密钥来进行加密和解密，这两个密钥是公开密钥（public key，简称公钥）和私有密钥（private key，简称私钥）。

想要能正常完成加密解密过程，就必需配对使用，而在使用过程中，“公钥”是公开的，“私钥”则必须由发送人保密，同时只能由持有人所有。对称式的加密方法如果用于通过网络传输加密文件，那么不管使用任何方法将密钥告诉对方，都有可能被窃听，而非对称式的加密方法则具有一定的**优越性**，`因为它包含有两个密钥，且仅有其中的“公钥”是可以被公开的，接收方只需要使用自己已持有的私钥进行解密，这样就可以很好的避免密钥在传输过程中产生的安全问题。`

常见的对称加密算法：DES，AES，3DES等等。



加解密过程:

- 服务端生成配对的公钥和私钥
- 私钥保存在服务端, 公钥发送给客户端
- 客户端使用公钥加密明文传输给服务端
- 服务端使用私钥解密密文得到明文



<img src="https://img-blog.csdnimg.cn/20190314090627135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5nc2hhbmdjaHVuamllemk=,size_16,color_FFFFFF,t_70" style="zoom:67%;" />



## 数字签名



数字在浏览器和服务器之间传输, 有可能在传输过程中被冒充的黑客把内容替换了, 那么如何保证数据是真实服务器发送的而不被调包呢, 同事如何保证传输的数据没有被人篡改呢?

可以在数据上防止数字签名, 数字签名是数据上的"戳记", 对于客户端来说是唯一的, 很难伪造. 此外, 签名保证不会对已签名的数据进行任何更改



使用数字签名通信过程, 使用写信的消息传输举例, 信的内容加解密过程省略

- 写完信后, 先使用 hash 函数, 生成信件摘要 (digest) . 此过程不可逆
- 使用私钥对 digest 进行加密, 生成数字签名 signature
- 将签名 signature 附在信件下发送给收信人
- 收信人收到信件, 取下数字签名 signature, 如何能得到 digest, 由此证明是发件人发出的
- 收信人对信件本身使用 hash 函数, 如果得到的结果与 digest 一致, 就证明未被修改过



## 数字证书



数字签名解决了内容被篡改的问题, 但还是不能完全避免黑客截获了公钥后模拟服务端和客户端通信

<img src="https://img-blog.csdnimg.cn/20190314091353262.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5nc2hhbmdjaHVuamllemk=,size_16,color_FFFFFF,t_70" style="zoom:67%;" />





<img src="https://img-blog.csdnimg.cn/20190314091522433.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5nc2hhbmdjaHVuamllemk=,size_16,color_FFFFFF,t_70" style="zoom:67%;" />

这时就不能确定的公钥是否是真的



**证书机制**

1. 作为服务端的小红，首先把自己的公钥发给证书颁发机构，向证书颁发机构申请证书。

2. 证书颁发机构自己也有一对公钥私钥。机构利用自己的私钥来加密Key1，并且通过服务端网址等信息生成一个证书签名，证书签名同样经过机构的私钥加密。证书制作完成后，机构把证书发送给了服务端小红。

3. 当小灰向小红请求通信的时候，小红不再直接返回自己的公钥，而是把自己申请的证书返回给小灰。

4. 小灰收到证书以后，要做的第一件事情是验证证书的真伪。需要说明的是，**各大浏览器和操作系统已经维护了所有权威证书机构的名称和公钥**。所以小灰只需要知道是哪个机构颁布的证书，就可以从本地找到对应的机构公钥，解密出证书签名。



<img src="https://img-blog.csdnimg.cn/20190314093122366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ppYW5nc2hhbmdjaHVuamllemk=,size_16,color_FFFFFF,t_70" style="zoom:67%;" />



## https



在很多网站都是使用 https 来传递, 则表示当前页面是通过 https 来传递的, 目前来说可以保证网易内容没有被篡改以及即使第三方截取到了通信内容也无法从密文获取到明文



<img src="https://oscimg.oschina.net/oscnet/6080859b-ccf8-4244-960a-a1cfb52aee61.png" style="zoom:50%;" />



这样就能保证通信安全了么? 



### 重放攻击



重放攻击(Replay Attacks)又称重播攻击、回放攻击，是指攻击者发送一个目的主机已接收过的包，来达到欺骗系统的目的，主要用于身份认证过程，破坏认证的正确性。重放攻击可以由发起者，也可以由拦截并重发该数据的敌方进行。攻击者利用网络监听或者其他方式盗取认证凭据，之后再把它重新发给认证服务器。重放攻击在任何网络通过程中都可能发生，是计算机世界黑客常用的攻击方式之一。

如: Amy 向 Bob 发送已经加密的信息, Bob 通过这个消息来验证 Amy 的身份, 这样如果中间信息被 Cidy 截获的话, 也向 Bob 发送相同的消息, Bob 就会认为 Cidy 就是 Amy



例如, 在登录时的**常规流程**

1. 前端输入账号, 密码, 点击登录
2. 请求提交之前, 通过客户端脚本, 如 js 对密码原文进行 md5 加密
3. 提交账号, md5之后的密码
4. 请求提交至后端, 验证账号密码是否与数据库一致来判断是否登录成功



以上流程的**问题**:

在传输过程中, 密码是 md5 后的, 即使被截取到, 也不会泄密. 但是只有获取到 md5 后的密码就可以登录



**解决方案**:

1. 进入登录页面, 生成一个随机码 (盐), 在客户端页面和 session 中各保存一份
2. 客户端提交登录, 将 md5 后的密码与该随机码拼接后再 md5, 然后提交  `提交的密码 =md5(md5(密码)+随机码)` 
3. 后端接收到登录请求后, 将从数据库中查询出的密码与 session 中的随机码拼接后, md5 运算, 然后与前端结果进行比较



**更进一步**

md5 出现了这么多年, 已经存在了不少字典, 同事为了方便用户登录, 一般不能要求用户设置很长, 很复杂的密码. 这是可以使用**固定盐值**



**改进后的步骤 :**

1. 系统设置一个固定盐值, 改盐值最好足够复杂, 如 1QWe324dsfi0kdf28df?!S
2. 用户注册, 修改密码时, 将用户原始密码与固定盐值拼接, 然后 md5
3. 传递至后端, 保存进数据库 (对数据库中保存的密码是用户原始密码拼接固定盐值后md5的结果)
4. 登录时, 将用户的原始密码与我们的固定盐值进行拼接, 然后做 md5 运算, 运算后的结果再拼接上我们的随机码, 再次md5提交
5. 后端接收到请求后, 将从数据库中查询的密码与 session 中的随机码进行拼接后, md5运算, 然后与前端传递的结果进行比较



**再进一步**

1. 加登录验证码, 可以预防人为暴力破解登录
2. 账户锁定, 如果用户密码输入错误次数到的一定量后 ( 如: 输错 6 次 ), 则锁定账户
3. 时间戳 + 随机参数



### 中间人攻击



中间人攻击（Man-in-the-MiddleAttack，简称“MITM攻击”）是一种“间接”的入侵攻击，这种攻击模式是通过各种技术手段将受入侵者控制的一台计算机虚拟放置在网络连接中的两台通信计算机之间，这台计算机就称为“中间人”。中间人与原本通信的两个实体分别建立通信, 斌交换攻击者所收到的数据, 让原本同学的两个实体误以为自己在一条加密的信道中核对方直接对话, 但其实整个通话过程都收到攻击者的控制, 攻击者可以随意增加/删除/修改通信的内容

一般来说, 加密协议都会加入一些特殊的方法来实现通信双方的互相认证, 以避免中间人攻击. 如 https 的证书机制来防止中间人攻击



**解决方案**: 使用证书机制 CA



